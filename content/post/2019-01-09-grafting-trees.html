---
title: "Grafting phylogenies"
author: "Cecina Babich Morrow"
date: 2019-01-18T21:13:14-05:00
categories: ["R", "phylogenetics", "evolution"]
tags: ["R", "phylogenetics", "evolution"]
---



<figure>
<img class="special-img-class" style="width:100%" src="/img/bodymass_tetrapod_tree.png" />
</figure>
<div id="inspiration-for-this-post" class="section level1">
<h1>Inspiration for this post</h1>
<p>This post comes from the finishing touches I needed to put on a paper about <a href="https://babichmorrowc.github.io/project/life_history/">life history evolution</a>. The paper compares life history traits across the four groups of tetrapods (amphibians, reptiles, mammals, and birds), so when I carried out the nitty gritty phylogenetic analyses, I used four separate phylogenies. When it came time to make a figure to visualize those analyses, however, I ended up with an unwieldy (and unpublishable) 16-panel figure (four phylogenies by four traits). One of my coauthors suggested using a tetrapod supertree to visualize the evolution of the traits across all four classes simultaneously.</p>
<div id="uyeda-et-al.-2017" class="section level2">
<h2>Uyeda et al. 2017</h2>
<p>Uyeda et al. did something similar in their 2017 paper <a href="https://www.journals.uchicago.edu/doi/10.1086/692326">The evolution of energetic scaling across the vertebrate tree of life</a>. They stitched together fish, amphibian, squamate, bird, and mammal phylogenies together to visualize metabolic rate across all vertebrates:</p>
<figure>
<img class="special-img-class" style="width:75%" src="/img/uyeda_figure.png" />
<figcaption>
Figure 1 from Uyeda et al. 2017
</figcaption>
</figure>
<p>At first, I was very hopeful that I would be able to download this supertree and prune it to the taxa in my analysis since the authors were using the same clade specific phylogenies that I was. The phylogeny is available on Data Dryad (<a href="https://datadryad.org/resource/doi:10.5061/dryad.3c6d2" class="uri">https://datadryad.org/resource/doi:10.5061/dryad.3c6d2</a>). Unfortunately, after downloading that phylogeny and pruning it to include species I used in my analysis, I ended up with approximately 15% of the species I analyzed in the resulting tree.</p>
</div>
</div>
<div id="into-the-code" class="section level1">
<h1>Into the code</h1>
<p>Since my easy solution didn’t pan out and I couldn’t get enough information from the supplemental material for the paper to replicate their analyses, I looked on GitHub to try to find Uyeda’s code. Hooray for GitHub once again, because the repository for the paper can be found here: <a href="https://github.com/uyedaj/bmr" class="uri">https://github.com/uyedaj/bmr</a>. The <a href="https://github.com/uyedaj/bmr/blob/master/R/ManuscriptNotebook.Rmd">RMarkdown</a> details the analyses for the paper, including the process for making the full tree.</p>
<p>Start with loading the necessary packages.</p>
<pre class="r"><code>library(phytools)
## Loading required package: ape
## Warning: package &#39;ape&#39; was built under R version 3.5.2
## Loading required package: maps
library(geiger)</code></pre>
<div id="the-original-phylogenies" class="section level2">
<h2>The original phylogenies</h2>
<p>I was working with four separate phylogenies: amphibians, squamates, birds, and mammals. For amphibians, I used a congruified time-tree from the <code>PhyloOrchard</code> package (O’Meara et al. 2013) that was constructed using the Alfaro et al. timetree of gnathostomes (Alfaro et al. 2009) as the reference and the Pyron and Wiens amphibian phylogeny as the target (Pyron and Wiens 2011).</p>
<pre class="r"><code>length(amphibiantree$tip.label)
## [1] 2871
plot(amphibiantree, type = &quot;fan&quot;, show.tip.label = FALSE)</code></pre>
<p><img src="/post/2019-01-09-grafting-trees_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>For squamates, I used the Zheng and Wiens time-calibrated phylogeny (Zheng and Wiens 2016).</p>
<pre class="r"><code>length(squamatetree$tip.label)
## [1] 378
plot(squamatetree, type = &quot;fan&quot;, show.tip.label = FALSE)</code></pre>
<p><img src="/post/2019-01-09-grafting-trees_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>For birds, I used the Jetz phylogeny (Jetz et al. 2012).</p>
<pre class="r"><code>length(birdtree$tip.label)
## [1] 9993
plot(birdtree, type = &quot;fan&quot;, show.tip.label = FALSE)</code></pre>
<p><img src="/post/2019-01-09-grafting-trees_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>For mammals, I used the supertree from Fritz et al. 2009.</p>
<pre class="r"><code>length(mammaltree$tip.label)
## [1] 5020
plot(mammaltree, type = &quot;fan&quot;, show.tip.label = FALSE)</code></pre>
<p><img src="/post/2019-01-09-grafting-trees_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>
<div id="reading-in-trees" class="section level2">
<h2>Reading in trees</h2>
<p>The first step of the process is reading in the individual phylogenies you want to stitch together. This step is straightforward, with one exception: you cannot have species that are present in multiple of the individual trees. For example, my squamate phylogeny included <em>Gallus gallus</em> (red junglefowl) and <em>Dromaius novaehollandia</em> (emu). Since these species were also present in my bird phylogeny, I got the following error: <code>Found matching tips in 'subtree' and 'phy'</code>. To solve this problem, I just removed these tips from the squamate tree:</p>
<pre class="r"><code>squamatetree &lt;- drop.tip(phy = squamatetree, tip = c(&quot;Gallus_gallus&quot;, &quot;Dromaius_novaehollandiae&quot;))</code></pre>
<p>I ended up with the following list of trees and corresponding tip labels:</p>
<pre class="r"><code>tree_list &lt;- list(amphib=amphibiantree, birds=birdtree, squam=squamatetree, mamm=mammaltree)
class(tree_list) &lt;- &quot;multiPhylo&quot;</code></pre>
</div>
<div id="make-a-tree-with-orders" class="section level2">
<h2>Make a tree with orders</h2>
<p>In Uyeda et al. (2017), the authors were creating a phylogeny for all vertebrates, but for my analyses I was only examining tetrapods, so I didn’t have a fish phylogeny to include. The original code from Uyeda et al. to create a tree with the 5 vertebrate orders looks like this:</p>
<pre class="r"><code>tip.labels &lt;- c(&quot;fish&quot;, &quot;amphib&quot;, &quot;squam&quot;, &quot;birds&quot;, &quot;mamm&quot;)

## Make a tree with just orders:
edge &lt;- matrix(c(9, 4,
  9, 3,
  8, 5,
  8, 9,
  7, 8,
  7, 2,
  6, 7,
  6, 1), byrow=TRUE, ncol=2)
## Dates from Timetree of life (timetree.org)
edge.length &lt;- c(274.9, 274.9, 324.5, 324.5-274.9, 382.9-324.5, 382.9, 454.6-382.9 , 454.6)
Nnode &lt;- 4
ordertree &lt;- list(edge=edge, Nnode=Nnode, tip.label=tip.labels, edge.length=edge.length)
class(ordertree) &lt;- &#39;phylo&#39;
plot(ordertree)</code></pre>
<p><img src="/post/2019-01-09-grafting-trees_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>To visualize the results, we can add tip labels, node labels, and edge labels to the tree with the branch lengths:</p>
<pre class="r"><code>plot(ordertree)
tiplabels()
nodelabels()
edgelabels(ordertree$edge.length, bg=&quot;black&quot;, col=&quot;white&quot;, font=2)</code></pre>
<p><img src="/post/2019-01-09-grafting-trees_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<div id="getting-rid-of-fish" class="section level3">
<h3>Getting rid of fish</h3>
<p>Since I didn’t have fish, I needed to make a few modifications. First, <code>tip.labels</code> didn’t need “fish” in it anymore:</p>
<pre class="r"><code># remove &quot;fish&quot; from tip.labels:
tip.labels &lt;- c(&quot;amphib&quot;, &quot;squam&quot;, &quot;birds&quot;, &quot;mamm&quot;)</code></pre>
<p>Now, for the trickier part - I needed to modify the edge matrix. The edge matrix contains the starting and ending nodes for each edge in a tree. As we can see from the plot above, numbering works in the following way: the tips are numbered starting at the top from 1 to the number of tips and the nodes are numbered starting at the root and moving towards the tips. To get rid of fish, I needed to delete one tip from the tree and one node (the original root node). I sketched out what I wanted the new order tree to look like, complete with numbered nodes and tips, and created the following edge matrix:</p>
<pre class="r"><code>edge &lt;- matrix(c(7, 3,
  7, 2,
  6, 4,
  6, 7,
  5, 6,
  5, 1), byrow=TRUE, ncol=2)</code></pre>
<p>Since I was losing two edges from the phylogeny (the one going from the root to fish and the one from the root to the last common ancestor of tetrapods), I also needed to modify the edge lengths by removing 454.6-382.9 and 454.6:</p>
<pre class="r"><code>edge.length &lt;- c(274.9, 274.9, 324.5, 324.5-274.9, 382.9-324.5, 382.9)</code></pre>
<p>The final modification I needed was to decrease <code>Nnode</code> from 4 to 3:</p>
<pre class="r"><code>Nnode &lt;- 3</code></pre>
<p>So now…</p>
<pre class="r"><code>ordertree &lt;- list(edge=edge, Nnode=Nnode, tip.label=tip.labels, edge.length=edge.length)
class(ordertree) &lt;- &#39;phylo&#39;
plot(ordertree)
edgelabels(ordertree$edge.length, bg=&quot;black&quot;, col=&quot;white&quot;, font=2)</code></pre>
<p><img src="/post/2019-01-09-grafting-trees_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<p>…I was ready to go with an order-level tree onto which I could graft my individual phylogenies!</p>
</div>
<div id="node-dates" class="section level3">
<h3>Node dates</h3>
<p>…Not so fast. I ended up with an additional problem I needed to solve before grafting the trees together. I ran into the error <code>'split_age' is inconsistent with edge lengths in 'phy'</code>, which means that the earliest node in one of my individual phylogenies was older than the node age I gave in <code>edge.length</code>. By <a href="https://babichmorrowc.github.io/post/debug-r/">using <code>debug</code></a>, I was able to tell that the error occurred when I added the squamate tree. The oldest node in my squamate tree was 277.8 million years ago, but I had set the divergence time between birds and squamates at 274.9 mya, so R was having problems. The species causing the problem was the tuatara, which is the only surviving member of its order.</p>
<figure>
<img class="special-img-class" style="width:75%" src="/img/tuatara.png" />
<figcaption>
The pesky (yet very cute) tuatara (<a href="https://www.australiangeographic.com.au/blogs/creatura-blog/2017/12/the-tuatara/" class="uri">https://www.australiangeographic.com.au/blogs/creatura-blog/2017/12/the-tuatara/</a>)
</figcaption>
</figure>
<p>I had a couple of choices: either delete the tuatara from the squamate phylogeny or increase the age of the last common ancestor of birds and squamates when I created the vector <code>edge.length</code>. I chose to do the latter because why get rid of such a cool animal!</p>
<p>I went to <a href="http://timetree.org/" class="uri">http://timetree.org/</a> to see if I could find a reasonable range of estimates for this node. According to the website, which allows you to search for the divergence time between any two taxa, the estimated divergence of birds and squamates occurred 280 mya.</p>
<figure>
<img class="special-img-class" style="width:75%" src="/img/timetree_birdsquamate.png" />
<figcaption>
TimeTree results for divergence time of birds and squamates.
</figcaption>
</figure>
<p>So I ended up with the following code and order tree:</p>
<pre class="r"><code>tip.labels &lt;- c(&quot;amphib&quot;, &quot;squam&quot;, &quot;birds&quot;, &quot;mamm&quot;)
edge &lt;- matrix(c(7, 3,
  7, 2,
  6, 4,
  6, 7,
  5, 6,
  5, 1), byrow=TRUE, ncol=2)
edge.length &lt;- c(280, 280, 324.5, 324.5-274.9, 382.9-324.5, 382.9)
Nnode &lt;- 3
ordertree &lt;- list(edge=edge, Nnode=Nnode, tip.label=tip.labels, edge.length=edge.length)
class(ordertree) &lt;- &#39;phylo&#39;
plot(ordertree)
edgelabels(ordertree$edge.length, bg=&quot;black&quot;, col=&quot;white&quot;, font=2)</code></pre>
<p><img src="/post/2019-01-09-grafting-trees_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
<pre class="r"><code>tree_list &lt;- list(amphib=amphibiantree, birds=birdtree, squam=squamatetree, mamm=mammaltree)
class(tree_list) &lt;- &quot;multiPhylo&quot;</code></pre>
</div>
</div>
<div id="grafting-the-trees" class="section level2">
<h2>Grafting the trees</h2>
<p>The final step is grafting the individual trees onto the order tree in the proper place.</p>
<pre class="r"><code>#Add taxonomic information to tree
otax &lt;- data.frame(&quot;Class&quot;= ordertree$tip.label, &quot;Superclass&quot;=c(rep(&quot;Tetrapoda&quot;,2)))
rownames(otax) &lt;- ordertree$tip.label
classtree &lt;- nodelabel.phylo(ordertree, otax, ncores=1)

res &lt;- glomogram.phylo(classtree, tree_list)
plot(res, type = &quot;fan&quot;, show.tip.label = FALSE)</code></pre>
<p><img src="/post/2019-01-09-grafting-trees_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p>Voila - a tree with 18262 species of tetrapods!</p>
</div>
</div>
<div id="disclaimer" class="section level1">
<h1>Disclaimer</h1>
<p>I’d like to finish this post with a disclaimer: I am NOT a phylogeneticist (yet?). The supertree created in this analysis incorporates several different phylogenies from literature and adapts code from another published article (all written by people with much more phylogenetic background than I!). However, the accuracy of the tree decreases as you move back in time - there is a great deal of uncertainty about node age for the deeper nodes in the tree. Even so, this process allows us to make some cool visualizations to compare major clades across vast stretches of evolutionary time - even if precise dates are incorrect, overall patterns are still informative!</p>
</div>
<div id="code" class="section level1">
<h1>Code</h1>
<p>The entire script I used for this process can be found at <a href="https://github.com/KerkhoffLab/bodymasspatterns/blob/master/tetrapod_phylogeny_code.R" class="uri">https://github.com/KerkhoffLab/bodymasspatterns/blob/master/tetrapod_phylogeny_code.R</a>.</p>
<p>#Literature Cited</p>
<p>Alfaro, M. E., F. Santini, C. Brock, H. Alamillo, A. Dornburg, D. L. Rabosky, G. Carnevale, and L. J. Harmon. 2009. Nine exceptional radiations plus high turnover explain species diversity in jawed vertebrates. PNAS 106:13410-13414.</p>
<p>Fritz, S. A., O. R. P. Bininda-Emonds, and A. Purvis. 2009. Geographical variation in predictors of mammalian extinction risk: big is bad, but only in the tropics. Ecology Letters 12:538–549.</p>
<p>Jetz, W., G. H. Thomas, J. B. Joy, K. Hartmann, and A. O. Mooers. 2012. The global diversity of birds in space and time. Nature 491:444.</p>
<p>O’Meara, B. C., L. J. Harmon, and J. Eastman. 2013. PhyloOrchard: Important and/or useful phylogenetic datasets.</p>
<p>Pyron, R. A. and J. J. Wiens. 2011. A large-scale phylogeny of Amphibia including over 2800 species, and a revised classification of extant frogs, salamanders, and caecilians. Molecular Phylogenetics and Evolution 61: 543-583.</p>
<p>Uyeda JC, Pennell MW, Miller ET, Maia R, McClain CR (2017) The evolution of energetic scaling across the vertebrate tree of life. The American Naturalist 190(2): 185-199. <a href="https://doi.org/10.1086/692326" class="uri">https://doi.org/10.1086/692326</a></p>
<p>Uyeda JC, Pennell MW, Miller ET, Maia R, McClain CR (2017) Data from: The evolution of energetic scaling across the vertebrate tree of life. Dryad Digital Repository. <a href="https://doi.org/10.5061/dryad.3c6d2" class="uri">https://doi.org/10.5061/dryad.3c6d2</a></p>
<p>Zheng, Y., and J. J. Wiens. 2016. Combining phylogenomic and supermatrix approaches, and a time-calibrated phylogeny for squamate reptiles (lizards and snakes) based on 52 genes and 4162 species. Molecular Phylogenetics and Evolution 94:537–547.</p>
</div>
